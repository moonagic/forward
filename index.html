<!DOCTYPE html>
<html lang="en" data-bs-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Port Forwarder Configuration</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --bs-body-bg-rgb: 248, 249, 250;
            --primary-rgb: 13, 110, 253;
            --card-bg-rgb: 255, 255, 255;
        }

        [data-bs-theme="dark"] {
            --bs-body-bg-rgb: 10, 14, 24;
            --primary-rgb: 110, 168, 253;
            --card-bg-rgb: 23, 28, 42;
        }

        body {
            background-color: rgb(var(--bs-body-bg-rgb));
            transition: background-color 0.3s ease;
            font-family: 'Inter', sans-serif;
        }

        .navbar {
            background-color: rgba(var(--card-bg-rgb), 0.8);
            backdrop-filter: blur(10px);
        }

        .card {
            background-color: rgb(var(--card-bg-rgb));
            border: 1px solid rgba(var(--primary-rgb), 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 .5rem 1.5rem rgba(var(--primary-rgb), 0.15) !important;
        }

        .btn-delete {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .rule-card-enter {
            animation: rule-enter 0.5s ease-out;
        }

        @keyframes rule-enter {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>

<body>

    <nav class="navbar navbar-expand-lg sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-hdd-network-fill text-primary"></i>
                Port Forwarder
            </a>
            <div class="d-flex align-items-center">
                <span id="client-ip" class="navbar-text me-3 text-muted fs-sm"></span>
                <button id="theme-switcher" class="btn border-0">
                    <i class="bi bi-sun-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-5">
        <div
            class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 pb-3 border-bottom border-primary-subtle">
            <h1 class="text-body-emphasis mb-3 mb-md-0">Configuration Rules</h1>
            <div class="d-grid d-md-flex gap-2">
                <button id="add-rule" class="btn btn-primary"><i class="bi bi-plus-circle-fill me-2"></i>Add
                    Rule</button>
                <button id="allow-my-ip" class="btn btn-info"><i class="bi bi-person-check-fill me-2"></i>Allow My IP Range</button>
                <button id="allow-current-ip" class="btn btn-warning"><i class="bi bi-shield-check me-2"></i>Allow Current IP</button>
                <button id="save-config" class="btn btn-success"><i class="bi bi-check-circle-fill me-2"></i>Save and
                    Apply</button>
            </div>
        </div>

        <!-- Temporary IP Pool Section -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-info bg-opacity-10">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check-fill text-info me-2"></i>
                    Temporary IP Whitelist
                    <span id="ip-pool-count" class="badge bg-info rounded-pill ms-2">0/10</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    These IPs are temporarily allowed through all rules. Pool uses LRU (Least Recently Used) eviction when full.
                </p>
                <div id="ip-pool-container" class="row g-2">
                    <div class="col-12 text-center text-muted py-3" id="ip-pool-empty">
                        <i class="bi bi-inbox display-6 d-block mb-2"></i>
                        No temporary IPs currently allowed
                    </div>
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button id="refresh-ip-pool" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>

        <div id="rules-container" class="row g-4"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto"><i class="bi bi-bell-fill"></i> Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const rulesContainer = document.getElementById('rules-container');
            const addRuleBtn = document.getElementById('add-rule');
            const saveConfigBtn = document.getElementById('save-config');
            const allowMyIpBtn = document.getElementById('allow-my-ip');
            const allowCurrentIpBtn = document.getElementById('allow-current-ip');
            const refreshIpPoolBtn = document.getElementById('refresh-ip-pool');
            const themeSwitcherBtn = document.getElementById('theme-switcher');
            const htmlEl = document.documentElement;

            const toastEl = document.getElementById('liveToast');
            const toastBody = toastEl.querySelector('.toast-body');
            const bsToast = new bootstrap.Toast(toastEl);

            let currentConfig = {};

            // --- IP Pool Management ---
            const loadIPPool = async () => {
                try {
                    const response = await fetch('/api/ip-pool');
                    if (!response.ok) return;
                    const data = await response.json();

                    const poolContainer = document.getElementById('ip-pool-container');
                    const poolCount = document.getElementById('ip-pool-count');
                    const poolEmpty = document.getElementById('ip-pool-empty');

                    poolCount.textContent = `${data.currentSize}/${data.maxSize}`;

                    if (data.ips && data.ips.length > 0) {
                        poolEmpty.style.display = 'none';
                        poolContainer.innerHTML = data.ips.map((ip, index) => `
                            <div class="col-md-6 col-lg-4">
                                <div class="d-flex align-items-center justify-content-between bg-light rounded p-2 ${htmlEl.getAttribute('data-bs-theme') === 'dark' ? 'bg-dark' : 'bg-light'}">
                                    <span class="text-monospace fw-bold">${ip}</span>
                                    <span class="badge bg-secondary rounded-pill">#${index + 1}</span>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        poolEmpty.style.display = 'block';
                        poolContainer.innerHTML = '';
                    }
                } catch (error) {
                    console.error('Error loading IP pool:', error);
                }
            };

            // --- IP Fetching ---
            const fetchAndDisplayIP = async () => {
                try {
                    const response = await fetch('/api/ip');
                    if (!response.ok) return;
                    const data = await response.json();
                    const ipEl = document.getElementById('client-ip');
                    if (data.ip) {
                        ipEl.innerHTML = `<i class="bi bi-pc-display-horizontal"></i> <strong>Your IP:</strong> ${data.ip}`;
                    }
                } catch (error) {
                    console.error('Error fetching IP:', error);
                }
            };

            // --- Theme Management ---
            const getStoredTheme = () => localStorage.getItem('theme');
            const setStoredTheme = theme => localStorage.setItem('theme', theme);

            const applyTheme = (theme) => {
                htmlEl.setAttribute('data-bs-theme', theme);
                themeSwitcherBtn.innerHTML = theme === 'dark' ?
                    '<i class="bi bi-moon-stars-fill"></i>' :
                    '<i class="bi bi-sun-fill"></i>';
            };

            const preferredTheme = getStoredTheme() || 'light';
            applyTheme(preferredTheme);

            themeSwitcherBtn.addEventListener('click', () => {
                const currentTheme = htmlEl.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setStoredTheme(newTheme);
                applyTheme(newTheme);
            });

            // --- Core Logic ---
            const showToast = (message, isError = false) => {
                toastBody.textContent = message;
                toastEl.classList.remove('bg-success-subtle', 'text-success-emphasis', 'bg-danger-subtle',
                    'text-danger-emphasis');
                toastEl.classList.add(isError ? 'bg-danger-subtle' : 'bg-success-subtle', isError ?
                    'text-danger-emphasis' : 'text-success-emphasis');
                bsToast.show();
            };

            const renderRule = (rule, index) => {
                const ruleWrapper = document.createElement('div');
                ruleWrapper.className = 'col-12 rule-card-enter';

                const ruleEl = document.createElement('div');
                ruleEl.className = 'card rule shadow-sm';
                ruleEl.dataset.index = index;

                const protocols = rule.protocols || [];
                const allowedIPs = rule.allowed_ips || [];

                const ipListHTML = allowedIPs.map(ip => `
                    <div class="input-group mb-2">
                        <input type="text" class="form-control rule-allowed-ip" value="${ip}" placeholder="e.g., 192.168.1.1">
                        <button class="btn btn-outline-danger remove-ip-btn" type="button"><i class="bi bi-trash"></i></button>
                    </div>
                `).join('');

                ruleEl.innerHTML = `
                    <div class="card-body position-relative">
                        <button type="button" class="btn btn-danger btn-delete" aria-label="Delete"><i class="bi bi-trash-fill"></i></button>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">Protocols</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input rule-proto-tcp" type="checkbox" value="tcp" ${protocols.includes('tcp') ? 'checked' : ''}>
                                        <label class="form-check-label">TCP</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input rule-proto-udp" type="checkbox" value="udp" ${protocols.includes('udp') ? 'checked' : ''}>
                                        <label class="form-check-label">UDP</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6 mb-3">
                                <label class="form-label fw-bold">Source (From)</label>
                                <input type="text" class="form-control rule-from" value="${rule.from || ''}" placeholder="e.g., 0.0.0.0:8080">
                            </div>
                            <div class="col-lg-6 mb-3">
                                <label class="form-label fw-bold">Destination (To)</label>
                                <input type="text" class="form-control rule-to" value="${rule.to || ''}" placeholder="e.g., 127.0.0.1:80">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Allowed IPs <span class="text-muted fw-normal">(Leave blank to allow all)</span></label>
                            <div class="allowed-ips-list">
                                ${ipListHTML}
                            </div>
                            <button class="btn btn-outline-primary btn-sm mt-2 add-ip-btn" type="button"><i class="bi bi-plus-circle me-1"></i>Add IP</button>
                        </div>
                    </div>
                `;
                ruleWrapper.appendChild(ruleEl);
                rulesContainer.appendChild(ruleWrapper);
            };

            const loadConfig = async () => {
                try {
                    const response = await fetch('/api/config');
                    if (!response.ok) throw new Error('Failed to load configuration.');
                    currentConfig = await response.json();
                    rulesContainer.innerHTML = '';
                    (currentConfig.forwards || []).forEach(renderRule);
                } catch (error) {
                    showToast(error.message, true);
                }
            };

            const saveConfig = async () => {
                const newForwards = [];
                const ruleElements = document.querySelectorAll('.rule');
                let hasError = false;
                let errorMsg = '';

                ruleElements.forEach(el => {
                    const from = el.querySelector('.rule-from').value;
                    const to = el.querySelector('.rule-to').value;
                    if (!from || !to) {
                        hasError = true;
                        errorMsg = "Fields 'Source (From)' and 'Destination (To)' cannot be empty.";
                    }

                    const protocols = [];
                    if (el.querySelector('.rule-proto-tcp').checked) protocols.push('tcp');
                    if (el.querySelector('.rule-proto-udp').checked) protocols.push('udp');

                    if (protocols.length === 0) {
                        hasError = true;
                        errorMsg = 'Each rule must have at least one protocol (TCP or UDP) selected.';
                    }

                    const allowed_ips = Array.from(el.querySelectorAll('.rule-allowed-ip')).map(input =>
                        input.value.trim()).filter(ip => ip);
                    newForwards.push({
                        protocols,
                        from,
                        to,
                        allowed_ips
                    });
                });

                if (hasError) {
                    showToast(errorMsg, true);
                    return;
                }

                const newConfig = {
                    admin_addr: currentConfig.admin_addr,
                    basic_auth: currentConfig.basic_auth,
                    forwards: newForwards
                };

                try {
                    saveConfigBtn.disabled = true;
                    saveConfigBtn.innerHTML =
                        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newConfig)
                    });
                    const responseText = await response.text();
                    if (!response.ok) throw new Error(`Failed to save: ${responseText}`);

                    showToast('Configuration saved and reloaded successfully!');
                    currentConfig = newConfig;
                    // Reload to reflect sorted order from backend if any
                    loadConfig();
                } catch (error) {
                    showToast(error.message, true);
                } finally {
                    saveConfigBtn.disabled = false;
                    saveConfigBtn.innerHTML =
                        '<i class="bi bi-check-circle-fill me-2"></i>Save and Apply';
                }
            };

            addRuleBtn.addEventListener('click', () => renderRule({}, rulesContainer.children.length));

            rulesContainer.addEventListener('click', e => {
                const ruleCard = e.target.closest('.col-12');

                if (e.target.closest('.btn-delete')) {
                    if (confirm('Are you sure you want to delete this rule?')) {
                        ruleCard.remove();
                    }
                } else if (e.target.closest('.add-ip-btn')) {
                    const ipListContainer = e.target.closest('.mb-3').querySelector(
                        '.allowed-ips-list');
                    const newIpInputHTML = `
                        <div class="input-group mb-2">
                            <input type="text" class="form-control rule-allowed-ip" placeholder="e.g., 192.168.1.1">
                            <button class="btn btn-outline-danger remove-ip-btn" type="button"><i class="bi bi-trash"></i></button>
                        </div>
                    `;
                    ipListContainer.insertAdjacentHTML('beforeend', newIpInputHTML);
                } else if (e.target.closest('.remove-ip-btn')) {
                    e.target.closest('.input-group').remove();
                }
            });

            saveConfigBtn.addEventListener('click', saveConfig);

            allowMyIpBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to add your IP range (/24) to all rules?')) {
                    return;
                }

                try {
                    allowMyIpBtn.disabled = true;
                    allowMyIpBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';

                    const response = await fetch('/api/allow-my-ip', {
                        method: 'POST',
                    });

                    const responseText = await response.text();
                    if (!response.ok) {
                        throw new Error(`Failed to allow IP range: ${responseText}`);
                    }

                    showToast(responseText);
                    loadConfig(); // Refresh the config to show the new IP
                } catch (error) {
                    showToast(error.message, true);
                } finally {
                    allowMyIpBtn.disabled = false;
                    allowMyIpBtn.innerHTML = '<i class="bi bi-person-check-fill me-2"></i>Allow My IP Range';
                }
            });

            allowCurrentIpBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to add your current IP to the temporary whitelist?')) {
                    return;
                }

                try {
                    allowCurrentIpBtn.disabled = true;
                    allowCurrentIpBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';

                    const response = await fetch('/api/allow', {
                        method: 'POST',
                    });

                    const responseText = await response.text();
                    if (!response.ok) {
                        throw new Error(`Failed to allow current IP: ${responseText}`);
                    }

                    showToast(responseText);
                    loadIPPool(); // Refresh IP pool
                } catch (error) {
                    showToast(error.message, true);
                } finally {
                    allowCurrentIpBtn.disabled = false;
                    allowCurrentIpBtn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Allow Current IP';
                }
            });

            refreshIpPoolBtn.addEventListener('click', () => {
                loadIPPool();
            });

            loadConfig();
            fetchAndDisplayIP();
            loadIPPool();
        });
    </script>
</body>

</html>