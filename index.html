<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Forward">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Forward">
    <meta name="msapplication-TileColor" content="#0d6efd">
    <meta name="msapplication-config" content="browserconfig.xml">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="/shield-icon.svg" type="image/svg+xml">
    <link rel="shortcut icon" href="/shield-icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon"
        href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAxMjgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CiAgICA8dGl0bGU+RXhwYW5kZWQgVG9wIFNoaWVsZCBJY29uPC90aXRsZT4KICAgIDwhLS0gQmFja2dyb3VuZCBDb2xvciAtLT4KICAgIDxyZWN0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiBmaWxsPSIjZjhmOWZhIi8+CgogICAgPCEtLSBTaGllbGQgd2l0aCBPdXR3YXJkIEN1cnZlZCBUb3AgLS0+CiAgICA8cGF0aCAKICAgICAgICBkPSJNIDY0LDExOCBDIDQwLDEwMCAxMiw3NSAxMiwyMCBRIDY0LDggMTE2LDIwIEMgMTE2LDc1IDg4LDEwMCA2NCwxMTggWiIKICAgICAgICBmaWxsPSIjMGQ2ZWZkIgogICAgICAgIHN0cm9rZT0iIzBhNThjYSIKICAgICAgICBzdHJva2Utd2lkdGg9IjgiCiAgICAgICAgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIKICAgIC8+Cjwvc3ZnPgo=">
    <title>Forward Configuration</title>
    <!-- Prevent theme flash - must be before any CSS -->
    <script>
        (function() {
            function getSystemTheme() {
                return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
            }

            function getStoredTheme() {
                try {
                    return localStorage.getItem('theme');
                } catch (e) {
                    return null;
                }
            }

            // Priority: stored theme > system preference > light
            const storedTheme = getStoredTheme();
            const systemTheme = getSystemTheme();
            const theme = storedTheme || systemTheme;

            document.documentElement.setAttribute('data-bs-theme', theme);

            // Set theme-color meta tag immediately
            const meta = document.createElement('meta');
            meta.name = 'theme-color';
            meta.content = theme === 'dark' ? '#0a0e18' : '#f8f9fa';
            document.head.appendChild(meta);

            // Store system theme if no stored preference
            if (!storedTheme) {
                try {
                    localStorage.setItem('theme', theme);
                } catch (e) {
                    // Ignore localStorage errors
                }
            }
        })();
    </script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        :root {
            --bs-body-bg-rgb: 248, 249, 250;
            --primary-rgb: 13, 110, 253;
            --card-bg-rgb: 255, 255, 255;
            --glassmorphism-bg: rgba(255, 255, 255, 0.1);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        [data-bs-theme="dark"] {
            --bs-body-bg-rgb: 10, 14, 24;
            --primary-rgb: 110, 168, 253;
            --card-bg-rgb: 23, 28, 42;
            --glassmorphism-bg: rgba(0, 0, 0, 0.2);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg,
                    rgb(var(--bs-body-bg-rgb)) 0%,
                    rgba(var(--primary-rgb), 0.05) 100%);
            min-height: 100vh;
            transition: all 0.3s ease;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding-top: 70px;
        }

        /* 简单直接的固定导航栏 */
        .navbar {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            z-index: 1030 !important;
            background: var(--glassmorphism-bg) !important;
            backdrop-filter: blur(20px) saturate(180%) !important;
            -webkit-backdrop-filter: blur(20px) saturate(180%) !important;
            border-bottom: 1px solid rgba(var(--primary-rgb), 0.1) !important;
        }

        /* Safari专用修复 - 极端强制固定 */
        @supports (-webkit-touch-callout: none) {

            /* 完全禁用Safari的所有滚动行为影响 */
            html,
            body {
                -webkit-overflow-scrolling: auto !important;
                overscroll-behavior: none !important;
                -webkit-transform: translateZ(0) !important;
                -webkit-perspective: 1000 !important;
                -webkit-backface-visibility: hidden !important;
            }

            .navbar {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                transform: translateZ(0) !important;
                -webkit-transform: translateZ(0) !important;
                -webkit-perspective: 1000 !important;
                -webkit-backface-visibility: hidden !important;
                isolation: isolate !important;
                will-change: auto !important;
                contain: layout style paint !important;
            }

            /* 强制浏览器重新计算布局 */
            .navbar::before {
                content: "";
                position: absolute;
                top: -1px;
                left: 0;
                right: 0;
                height: 1px;
                background: transparent;
                z-index: -1;
            }
        }

        /* iOS Safari 安全区域处理 */
        @supports (-webkit-touch-callout: none) {
            @media not (display-mode: standalone) {
                body {
                    padding-top: calc(70px + env(safe-area-inset-top)) !important;
                }

                .navbar {
                    padding-top: env(safe-area-inset-top) !important;
                    height: calc(70px + env(safe-area-inset-top)) !important;
                }
            }
        }

        /* Ensure dark mode has deep enough background */
        [data-bs-theme="dark"] .navbar {
            background: rgba(10, 14, 24, 0.95);
        }

        [data-bs-theme="dark"] .navbar::before {
            background: rgba(10, 14, 24, 0.95);
        }

        .navbar .container {
            padding-left: max(1rem, env(safe-area-inset-left));
            padding-right: max(1rem, env(safe-area-inset-right));
        }

        .navbar-brand {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card {
            background: var(--glassmorphism-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(var(--primary-rgb), 0.15);
            border-radius: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-light);
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(var(--primary-rgb), 0.2);
            border-color: rgba(var(--primary-rgb), 0.3);
        }

        .btn {
            border-radius: 12px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        /* Mobile button override */
        @media (max-width: 767.98px) {
            .btn {
                border-radius: 8px;
            }
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-delete {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            z-index: 10;
            flex-shrink: 0;
            min-width: 3rem;
            min-height: 3rem;
            max-width: 3rem;
            max-height: 3rem;
        }

        .rule-card-enter {
            animation: rule-enter 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes rule-enter {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Responsive Container */
        .container {
            max-width: 100%;
            padding-left: 1rem;
            padding-right: 1rem;
        }

        @media (min-width: 576px) {
            .container {
                max-width: 540px;
            }
        }

        @media (min-width: 768px) {
            .container {
                max-width: 720px;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }

        @media (min-width: 992px) {
            .container {
                max-width: 960px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1140px;
            }
        }

        @media (min-width: 1400px) {
            .container {
                max-width: 1320px;
            }
        }

        /* 移动端简化 */
        @media (max-width: 767.98px) {
            body {
                padding-top: 68px !important;
            }

            .navbar {
                height: 68px !important;
            }

            @supports (-webkit-touch-callout: none) {
                @media not (display-mode: standalone) {
                    body {
                        padding-top: calc(68px + env(safe-area-inset-top)) !important;
                    }

                    .navbar {
                        height: calc(68px + env(safe-area-inset-top)) !important;
                    }
                }
            }
        }

        .navbar-brand {
            font-size: 1.1rem;
        }

        .btn-delete {
            width: 2.5rem !important;
            height: 2.5rem !important;
            top: 0.75rem;
            right: 0.75rem;
            min-width: 2.5rem !important;
            min-height: 2.5rem !important;
            max-width: 2.5rem !important;
            max-height: 2.5rem !important;
            border-radius: 50% !important;
            flex-shrink: 0 !important;
            padding: 0 !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        .card-body {
            padding: 1rem;
        }

        .fs-sm {
            font-size: 0.8rem !important;
        }

        .btn-group-mobile {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn-group-mobile .btn {
            width: 100%;
            text-align: center;
        }

        .input-group-mobile {
            flex-direction: column;
            width: 100%;
        }

        .input-group-mobile .form-control {
            border-radius: 12px !important;
            margin-bottom: 0.5rem;
            width: 100% !important;
            flex: none;
            height: 44px !important;
        }

        .input-group-mobile .btn {
            border-radius: 12px !important;
            width: 100%;
            flex: none;
            height: 44px !important;
            min-height: 44px !important;
            max-height: 44px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
        }

        /* Override Bootstrap input-group behavior on mobile */
        .input-group-mobile.input-group {
            display: flex;
            flex-wrap: wrap;
        }

        .input-group-mobile.input-group>* {
            width: 100% !important;
            flex: none !important;
        }

        /* Force button height controls for mobile - ALL BUTTONS */
        .remove-ip-btn,
        .input-group-mobile .btn,
        .rule .input-group .btn {
            height: 44px !important;
            max-height: 44px !important;
            min-height: 44px !important;
            border-radius: 8px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
            gap: 0.5rem !important;
        }

        /* Style remove buttons specifically */
        .remove-ip-btn {
            background-color: var(--bs-danger) !important;
            border-color: var(--bs-danger) !important;
            color: white !important;
            width: 100% !important;
            border-radius: 8px !important;
        }

        .remove-ip-btn:hover {
            background-color: var(--bs-danger) !important;
            border-color: var(--bs-danger) !important;
            opacity: 0.9 !important;
        }

        /* Force button height controls for mobile */
        .input-group-mobile .btn,
        .rule .input-group .btn,
        .remove-ip-btn {
            height: 44px !important;
            max-height: 44px !important;
            min-height: 44px !important;
            line-height: 1.2 !important;
            padding: 0.5rem 0.75rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            align-self: flex-start !important;
        }

        /* Ensure all input-groups in rules are mobile-friendly */
        .rule .input-group {
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
            align-items: stretch !important;
        }

        .rule .input-group .form-control {
            width: 100% !important;
            margin-bottom: 0.5rem !important;
            border-radius: 12px !important;
            height: 44px !important;
        }

        .rule .input-group .btn {
            width: 100% !important;
            border-radius: 8px !important;
            height: 44px !important;
            min-height: 44px !important;
            max-height: 44px !important;
            align-self: flex-start !important;
            flex: none !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
            gap: 0.5rem !important;
        }

        /* Style remove buttons specifically */
        .remove-ip-btn {
            background-color: #dc3545 !important;
            border-color: #dc3545 !important;
            color: white !important;
            border-radius: 8px !important;
        }

        .remove-ip-btn:hover {
            background-color: #bb2d3b !important;
            border-color: #bb2d3b !important;
        }

        /* Style Add IP button */
        .add-ip-btn {
            border-radius: 8px !important;
            height: 40px !important;
            min-height: 40px !important;
            max-height: 40px !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 0.5rem !important;
        }

        /* Tablet responsive design */
        @media (min-width: 576px) {
            .btn-group-tablet {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            /* Ensure proper spacing on small+ screens */
            .btn-group-mobile {
                display: flex;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
        }

        @media (min-width: 768px) and (max-width: 991.98px) {
            .btn-group-tablet {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 0.5rem;
            }
        }

        /* Large desktop optimization */
        @media (min-width: 1200px) {

            .btn-group-mobile,
            .btn-group-tablet {
                display: flex;
                flex-wrap: nowrap;
                gap: 0.75rem;
                width: auto;
            }

            /* Ensure title and buttons stay on same line */
            .d-flex.flex-column.flex-sm-row {
                flex-wrap: nowrap;
            }

            .d-flex.flex-column.flex-sm-row h1 {
                white-space: nowrap;
                margin-right: 2rem;
            }
        }

        /* Enhanced form controls */
        .form-control {
            border-radius: 12px;
            border: 1px solid rgba(var(--primary-rgb), 0.2);
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .form-control:focus {
            border-color: rgb(var(--primary-rgb));
            box-shadow: 0 0 0 0.2rem rgba(var(--primary-rgb), 0.25);
        }

        .form-check-input {
            border-radius: 6px;
        }

        /* Ensure input groups work properly */
        .input-group {
            width: 100%;
        }

        .input-group .form-control {
            min-width: 0;
            flex: 1 1 auto;
        }

        /* IP Pool enhancements */
        .ip-pool-item {
            transition: all 0.3s ease;
        }

        .ip-pool-item:hover {
            transform: translateX(4px);
        }

        /* Toast improvements */
        .toast {
            border-radius: 12px;
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Loading states */
        .btn-loading {
            position: relative;
            pointer-events: none;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            margin: auto;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Dark mode specific enhancements */
        [data-bs-theme="dark"] .card {
            background: rgba(var(--card-bg-rgb), 0.7);
        }

        [data-bs-theme="dark"] .navbar {
            background: rgba(var(--card-bg-rgb), 0.8);
        }

        /* 小屏幕简化 */
        @media (max-width: 575.98px) {
            body {
                padding-top: 66px !important;
            }

            .navbar {
                height: 66px !important;
            }

            @supports (-webkit-touch-callout: none) {
                @media not (display-mode: standalone) {
                    body {
                        padding-top: calc(66px + env(safe-area-inset-top)) !important;
                    }

                    .navbar {
                        height: calc(66px + env(safe-area-inset-top)) !important;
                    }
                }
            }
        }

        .container {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        .card-header .card-title {
            font-size: 1rem;
        }

        .badge {
            font-size: 0.7rem;
        }

        .text-monospace {
            font-size: 0.85rem;
        }

        h1 {
            font-size: 1.5rem;
        }

        .btn-delete {
            width: 2.5rem !important;
            height: 2.5rem !important;
            top: 0.75rem;
            right: 0.75rem;
            min-width: 2.5rem !important;
            min-height: 2.5rem !important;
            max-width: 2.5rem !important;
            max-height: 2.5rem !important;
            border-radius: 50% !important;
            flex-shrink: 0 !important;
            padding: 0 !important;
            line-height: 1 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
        }

        /* Ensure button text fits properly */
        .btn {
            font-size: 0.9rem;
            padding: 0.5rem 0.75rem;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.375rem 0.5rem;
        }

        /* Allow text wrapping for longer button labels */
        .btn span {
            white-space: normal;
            line-height: 1.2;
        }

        /* Force full width for IP input containers */
        .allowed-ips-list {
            width: 100%;
        }

        .allowed-ips-list .input-group,
        .allowed-ips-list .input-group-mobile {
            width: 100% !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .allowed-ips-list .form-control,
        .allowed-ips-list .rule-allowed-ip {
            width: 100% !important;
            margin-bottom: 0.5rem !important;
            border-radius: 12px !important;
            min-width: 0 !important;
            flex: none !important;
        }

        .allowed-ips-list .btn,
        .allowed-ips-list .remove-ip-btn {
            width: 100% !important;
            border-radius: 12px !important;
            flex: none !important;
            height: auto !important;
            min-height: 44px !important;
            max-height: 48px !important;
            align-self: flex-start !important;
        }

        /* Ensure rule form controls take full width */
        .rule-from,
        .rule-to {
            width: 100% !important;
        }

        /* Override any Bootstrap input-group styles on mobile */
        .card-body .input-group {
            width: 100% !important;
            flex-direction: column !important;
            align-items: stretch !important;
        }

        .card-body .input-group>* {
            width: 100% !important;
            flex: none !important;
            border-radius: 12px !important;
        }

        .card-body .input-group .form-control {
            margin-bottom: 0.5rem !important;
        }

        .card-body .input-group .btn {
            height: auto !important;
            min-height: 44px !important;
            max-height: 48px !important;
            align-self: flex-start !important;
        }

        /* Specific fix for IP input fields in rules */
        .rule .input-group {
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
            align-items: stretch !important;
        }

        .rule .input-group .form-control {
            width: 100% !important;
            margin-bottom: 0.5rem !important;
            border-radius: 12px !important;
            border-top-right-radius: 12px !important;
            border-bottom-right-radius: 12px !important;
        }

        .rule .input-group .btn {
            width: 100% !important;
            border-radius: 8px !important;
            border-top-left-radius: 8px !important;
            border-bottom-left-radius: 8px !important;
            height: 44px !important;
            min-height: 44px !important;
            max-height: 44px !important;
            align-self: flex-start !important;
            flex: none !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            flex-shrink: 0 !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
            gap: 0.5rem !important;
        }

        /* Style Add IP button */
        .add-ip-btn {
            border-radius: 8px !important;
            height: 40px !important;
            min-height: 40px !important;
            max-height: 40px !important;
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 0.5rem !important;
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
            }

            .btn-sm {
                min-height: 36px;
                padding: 0.5rem 0.75rem;
            }

            .form-control {
                min-height: 44px;
                font-size: 16px;
                /* Prevents zoom on iOS */
            }

            .form-check-input {
                width: 1.25rem;
                height: 1.25rem;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Focus improvements for keyboard navigation */
        .btn:focus,
        .form-control:focus,
        .form-check-input:focus {
            outline: 2px solid rgb(var(--primary-rgb));
            outline-offset: 2px;
        }
    </style>
    <link rel="preconnect" href="https://rsms.me/">
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>

<body>

    <nav class="navbar navbar-expand-lg shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-hdd-network-fill text-primary"></i>
                <span>Forward</span>
            </a>
            <div class="d-flex align-items-center gap-2">
                <span id="client-ip" class="navbar-text text-muted fs-sm"></span>
                <button id="logout-btn" class="btn btn-outline-danger btn-sm rounded-pill px-3">
                    <i class="bi bi-box-arrow-right me-1"></i>
                    <span class="d-none d-md-inline">Logout</span>
                </button>
                <button id="theme-switcher" class="btn border-0 rounded-pill p-2">
                    <i class="bi bi-sun-fill"></i>
                </button>
            </div>
        </div>
    </nav>

    <div class="container py-3">
        <div
            class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center mb-3 pb-2 border-bottom border-primary-subtle">
            <h1 class="text-body-emphasis mb-3 mb-sm-0">Configuration Rules</h1>
            <div class="btn-group-mobile btn-group-tablet d-grid d-sm-flex gap-2 w-100 w-sm-auto">
                <button id="add-rule" class="btn btn-primary">
                    <i class="bi bi-plus-circle-fill me-2"></i>
                    <span>Add Rule</span>
                </button>
                <button id="allow-my-ip" class="btn btn-info">
                    <i class="bi bi-person-check-fill me-2"></i>
                    <span class="d-none d-lg-inline">Allow My IP Range</span>
                    <span class="d-lg-none">My IP Range</span>
                </button>
                <button id="allow-current-ip" class="btn btn-warning">
                    <i class="bi bi-shield-check me-2"></i>
                    <span class="d-none d-lg-inline">Allow Current IP</span>
                    <span class="d-lg-none">Current IP</span>
                </button>
                <button id="view-duplicate-requests" class="btn btn-outline-danger" disabled>
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    <span class="d-none d-lg-inline">Duplicate Requests</span>
                    <span class="d-lg-none">Duplicates</span>
                </button>
                <button id="save-config" class="btn btn-success">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <span>Save and Apply</span>
                </button>
            </div>
        </div>

        <!-- Temporary IP Pool Section -->
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-info bg-opacity-10">
                <h5 class="card-title mb-0">
                    <i class="bi bi-shield-check-fill text-info me-2"></i>
                    Temporary IP Whitelist
                    <span id="ip-pool-count" class="badge bg-info rounded-pill ms-2">0/10</span>
                </h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    <i class="bi bi-info-circle me-1"></i>
                    <span>These IPs are temporarily allowed through all rules. Pool uses LRU (Least Recently Used)
                        eviction when full.</span>
                    <br><small class="text-success">
                        <i class="bi bi-arrow-up-circle"></i>
                        <strong>Top = Newest</strong>
                        <span class="d-none d-md-inline">(most recent, safe)</span>
                        <i class="bi bi-arrow-right"></i>
                        <strong>Bottom = Oldest</strong>
                        <span class="d-none d-md-inline">(will be evicted first)</span>
                        <i class="bi bi-arrow-down-circle text-danger"></i>
                    </small>
                </p>
                <div id="ip-pool-empty" class="text-center text-muted py-3" style="display: none;">
                    <i class="bi bi-inbox display-6 d-block mb-2"></i>
                    No temporary IPs currently allowed
                </div>
                <div id="ip-pool-container" class="d-flex flex-column gap-2">
                    <!-- IP列表纵向排列 -->
                </div>
                <div class="d-flex gap-2 mt-3">
                    <button id="refresh-ip-pool" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>

        <div id="rules-container" class="row g-4"></div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="liveToast" class="toast border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto"><i class="bi bi-bell-fill"></i> Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Service Worker Registration and PWA Install Prompt
        let deferredPrompt;
        let installButton;

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('[PWA] Service Worker registered:', registration);

                    // Force update to get the latest service worker
                    await registration.update();

                    // Handle updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New update available
                                showUpdateAvailable();
                            }
                        });
                    });
                } catch (error) {
                    console.error('[PWA] Service Worker registration failed:', error);
                }
            });
        }

        // PWA Install Prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });

        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App was installed');
            hideInstallButton();
            deferredPrompt = null;
        });

        function showInstallButton() {
            if (!installButton) {
                installButton = document.createElement('button');
                installButton.className = 'btn btn-outline-primary btn-sm position-fixed';
                installButton.style.cssText = `
                    bottom: 20px;
                    right: 20px;
                    z-index: 1050;
                    border-radius: 25px;
                    padding: 0.5rem 1rem;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    backdrop-filter: blur(10px);
                    background: rgba(255,255,255,0.9);
                `;
                installButton.innerHTML = '<i class="bi bi-download me-1"></i>Install App';
                installButton.addEventListener('click', installApp);
                document.body.appendChild(installButton);
            }
            installButton.style.display = 'block';
        }

        function hideInstallButton() {
            if (installButton) {
                installButton.style.display = 'none';
            }
        }

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const result = await deferredPrompt.userChoice;
                console.log('[PWA] User choice:', result);
                deferredPrompt = null;
                hideInstallButton();
            }
        }

        function showUpdateAvailable() {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'alert alert-info alert-dismissible fade show position-fixed';
            updateBanner.style.cssText = `
                top: 20px;
                left: 20px;
                right: 20px;
                z-index: 1060;
                max-width: 400px;
                margin: 0 auto;
            `;
            updateBanner.innerHTML = `
                <i class="bi bi-arrow-clockwise me-2"></i>
                <strong>Update Available!</strong>
                <span class="d-block d-sm-inline">Refresh to get the latest version.</span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                <div class="mt-2">
                    <button class="btn btn-sm btn-primary" onclick="window.location.reload()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh Now
                    </button>
                </div>
            `;
            document.body.appendChild(updateBanner);

            // Auto-hide after 10 seconds
            setTimeout(() => {
                if (updateBanner.parentNode) {
                    updateBanner.remove();
                }
            }, 10000);
        }


        document.addEventListener('DOMContentLoaded', async () => {

            // 检查认证状态
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    // 认证失败，跳转到登录页
                    window.location.href = '/login';
                    return;
                }
            } catch (error) {
                // 网络错误，也跳转到登录页
                window.location.href = '/login';
                return;
            }

            const rulesContainer = document.getElementById('rules-container');
            const addRuleBtn = document.getElementById('add-rule');
            const saveConfigBtn = document.getElementById('save-config');
            const allowMyIpBtn = document.getElementById('allow-my-ip');
            const allowCurrentIpBtn = document.getElementById('allow-current-ip');
            const viewDuplicateRequestsBtn = document.getElementById('view-duplicate-requests');
            const refreshIpPoolBtn = document.getElementById('refresh-ip-pool');
            const themeSwitcherBtn = document.getElementById('theme-switcher');
            const logoutBtn = document.getElementById('logout-btn');
            const htmlEl = document.documentElement;

            const toastEl = document.getElementById('liveToast');
            const toastBody = toastEl.querySelector('.toast-body');
            const bsToast = new bootstrap.Toast(toastEl);

            let currentConfig = {};
            let currentClientIP = '';
            let tempIPPool = [];

            // --- IP Pool Management ---
            const loadIPPool = async () => {
                try {
                    const response = await fetch('/api/ip-pool');
                    if (!response.ok) return;
                    const data = await response.json();

                    // Store IP pool data globally
                    tempIPPool = data.ips || [];

                    const poolContainer = document.getElementById('ip-pool-container');
                    const poolCount = document.getElementById('ip-pool-count');
                    const poolEmpty = document.getElementById('ip-pool-empty');

                    poolCount.textContent = `${data.currentSize}/${data.maxSize}`;

                    if (data.ips && data.ips.length > 0) {
                        poolEmpty.style.display = 'none';
                        // 实时获取当前主题
                        const currentTheme = htmlEl.getAttribute('data-bs-theme');
                        const bgClass = currentTheme === 'dark' ? 'bg-dark' : 'bg-light';

                        // 反转数组显示，让最新的IP在顶部
                        const reversedIps = [...data.ips].reverse();

                        poolContainer.innerHTML = reversedIps.map((ipEntry, displayIndex) => {
                            const originalIndex = data.ips.length - 1 - displayIndex;
                            const isNewest = originalIndex === data.ips.length - 1;
                            const isOldest = originalIndex === 0;
                            let badgeClass, badgeText, positionIcon, riskLevel;

                            if (isNewest) {
                                badgeClass = 'bg-success';
                                badgeText = 'Newest';
                                positionIcon = '<i class="bi bi-shield-check me-1"></i>';
                                riskLevel = 'border border-success';
                            } else if (isOldest) {
                                badgeClass = 'bg-danger';
                                badgeText = 'Oldest';
                                positionIcon = '<i class="bi bi-exclamation-triangle me-1"></i>';
                                riskLevel = 'border border-danger';
                            } else {
                                const totalIps = data.ips.length;
                                const riskScore = (totalIps - 1 - originalIndex) / (totalIps - 1);
                                if (riskScore < 0.3) {
                                    badgeClass = 'bg-warning text-dark';
                                    positionIcon = '<i class="bi bi-dash-circle me-1"></i>';
                                } else {
                                    badgeClass = 'bg-secondary';
                                    positionIcon = '';
                                }
                                badgeText = `#${displayIndex + 1}`;
                                riskLevel = '';
                            }

                            // Format last triggered time
                            const lastTriggered = new Date(ipEntry.last_triggered);
                            const now = new Date();
                            const diffMs = now - lastTriggered;
                            const diffMins = Math.floor(diffMs / (1000 * 60));
                            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                            let timeAgo;
                            if (diffDays > 0) {
                                timeAgo = `${diffDays}d ago`;
                            } else if (diffHours > 0) {
                                timeAgo = `${diffHours}h ago`;
                            } else if (diffMins > 0) {
                                timeAgo = `${diffMins}m ago`;
                            } else {
                                timeAgo = 'Just now';
                            }

                            return `
                                <div class="d-flex align-items-center justify-content-between ${bgClass} rounded p-2 ip-pool-item ${riskLevel}">
                                    <div class="flex-grow-1 me-2">
                                        <div class="text-monospace fw-bold" style="word-break: break-all;">${ipEntry.ip}</div>
                                        <small class="text-muted">
                                            <i class="bi bi-clock me-1"></i>Last used: ${timeAgo}
                                        </small>
                                    </div>
                                    <div class="d-flex align-items-center gap-2 flex-shrink-0">
                                        <span class="badge ${badgeClass} rounded-pill">${positionIcon}${badgeText}</span>
                                        <button class="btn btn-outline-danger btn-sm remove-temp-ip-btn" data-ip="${ipEntry.ip}" title="Remove IP">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('');
                    } else {
                        poolEmpty.style.display = 'block';
                        poolContainer.innerHTML = '';
                    }
                } catch (error) {
                    console.error('Error loading IP pool:', error);
                } finally {
                    // Update button state after loading IP pool
                    updateAllowCurrentIpButton();
                }
            };

            // --- IP Fetching ---
            const fetchAndDisplayIP = async () => {
                try {
                    const response = await fetch('/api/ip');
                    if (!response.ok) return;
                    const data = await response.json();

                    // Store current client IP globally
                    currentClientIP = data.ip || '';

                    const ipEl = document.getElementById('client-ip');
                    if (data.ip) {
                        // Show different format on mobile vs desktop
                        if (window.innerWidth < 768) {
                            ipEl.innerHTML = `<i class="bi bi-pc-display-horizontal"></i> ${data.ip}`;
                        } else {
                            ipEl.innerHTML = `<i class="bi bi-pc-display-horizontal"></i> <strong>Your IP:</strong> ${data.ip}`;
                        }
                    }
                } catch (error) {
                    console.error('Error fetching IP:', error);
                } finally {
                    // Update button state after fetching current IP
                    updateAllowCurrentIpButton();
                }
            };

            // --- Update Allow Current IP Button State ---
            const updateAllowCurrentIpButton = () => {
                // Check if current IP exists in temporary IP pool
                if (!currentClientIP || tempIPPool.length === 0) {
                    return;
                }

                const ipExistsInPool = tempIPPool.some(ipEntry => ipEntry.ip === currentClientIP);

                if (ipExistsInPool) {
                    // Disable button if IP already exists in pool
                    allowCurrentIpBtn.disabled = true;
                    allowCurrentIpBtn.title = 'Your IP is already in the temporary whitelist';
                } else {
                    // Enable button if IP is not in pool
                    allowCurrentIpBtn.disabled = false;
                    allowCurrentIpBtn.title = '';
                }
            };

            // --- Duplicate Requests Check ---
            const checkDuplicateRequests = async () => {
                try {
                    const response = await fetch('/api/duplicate-requests');
                    if (!response.ok) return;
                    const data = await response.json();

                    if (data.count > 0) {
                        // Enable button and update its appearance
                        viewDuplicateRequestsBtn.disabled = false;
                        viewDuplicateRequestsBtn.classList.remove('btn-outline-danger');
                        viewDuplicateRequestsBtn.classList.add('btn-danger');
                        // Add count badge to button
                        const existingBadge = viewDuplicateRequestsBtn.querySelector('.badge');
                        if (!existingBadge) {
                            const countBadge = document.createElement('span');
                            countBadge.className = 'badge bg-light text-dark rounded-pill ms-2';
                            countBadge.textContent = data.count;
                            viewDuplicateRequestsBtn.appendChild(countBadge);
                        } else {
                            existingBadge.textContent = data.count;
                        }
                    } else {
                        // Keep button disabled and in outline style
                        viewDuplicateRequestsBtn.disabled = true;
                        viewDuplicateRequestsBtn.classList.remove('btn-danger');
                        viewDuplicateRequestsBtn.classList.add('btn-outline-danger');
                        // Remove count badge if exists
                        const existingBadge = viewDuplicateRequestsBtn.querySelector('.badge');
                        if (existingBadge) {
                            existingBadge.remove();
                        }
                    }
                } catch (error) {
                    console.error('Error checking duplicate requests:', error);
                }
            };

            // --- Theme Management ---
            const getStoredTheme = () => localStorage.getItem('theme');
            const setStoredTheme = theme => localStorage.setItem('theme', theme);

            const applyTheme = (theme) => {
                htmlEl.setAttribute('data-bs-theme', theme);
                themeSwitcherBtn.innerHTML = theme === 'dark' ?
                    '<i class="bi bi-moon-stars-fill"></i>' :
                    '<i class="bi bi-sun-fill"></i>';

                // Update iOS status bar and theme color
                updateStatusBarForTheme(theme);
            };

            const updateStatusBarForTheme = (theme) => {
                // Update theme-color meta tag for address bar and PWA status bar
                let themeColorMeta = document.querySelector('meta[name="theme-color"]');
                if (!themeColorMeta) {
                    themeColorMeta = document.createElement('meta');
                    themeColorMeta.name = 'theme-color';
                    document.head.appendChild(themeColorMeta);
                }

                // Update apple-mobile-web-app-status-bar-style for PWA
                let statusBarMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
                if (!statusBarMeta) {
                    statusBarMeta = document.createElement('meta');
                    statusBarMeta.name = 'apple-mobile-web-app-status-bar-style';
                    document.head.appendChild(statusBarMeta);
                }

                // For PWA mode, always use default to avoid overlap issues
                if (theme === 'dark') {
                    themeColorMeta.content = '#0a0e18';
                    statusBarMeta.content = 'default';
                } else {
                    themeColorMeta.content = '#f8f9fa';
                    statusBarMeta.content = 'default';
                }
            };

            // Theme is already set by inline script, just sync the UI
            const currentTheme = htmlEl.getAttribute('data-bs-theme') || 'light';
            themeSwitcherBtn.innerHTML = currentTheme === 'dark' ?
                '<i class="bi bi-moon-stars-fill"></i>' :
                '<i class="bi bi-sun-fill"></i>';

            // Initialize status bar on page load
            updateStatusBarForTheme(currentTheme);

            // Listen for system theme changes
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                // Only auto-switch if user hasn't set a manual preference
                const storedTheme = getStoredTheme();
                if (!storedTheme) {
                    const newTheme = e.matches ? 'dark' : 'light';
                    applyTheme(newTheme);
                    loadIPPool(); // Refresh IP pool display
                }
            });

            themeSwitcherBtn.addEventListener('click', () => {
                const currentTheme = htmlEl.getAttribute('data-bs-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                setStoredTheme(newTheme);
                applyTheme(newTheme);
                // 主题切换后刷新IP池显示以更新背景色
                loadIPPool();
            });

            // --- Core Logic ---
            const showToast = (message, isError = false) => {
                toastBody.textContent = message;
                toastEl.classList.remove('bg-success-subtle', 'text-success-emphasis', 'bg-danger-subtle',
                    'text-danger-emphasis');
                toastEl.classList.add(isError ? 'bg-danger-subtle' : 'bg-success-subtle', isError ?
                    'text-danger-emphasis' : 'text-success-emphasis');
                bsToast.show();
            };

            const renderRule = (rule, index) => {
                const ruleWrapper = document.createElement('div');
                ruleWrapper.className = 'col-12 rule-card-enter';

                const ruleEl = document.createElement('div');
                ruleEl.className = 'card rule shadow-sm';
                ruleEl.dataset.index = index;

                const protocols = rule.protocols || [];
                const allowedIPs = rule.allowed_ips || [];

                const ipListHTML = allowedIPs.map(ip => `
                    <div class="input-group input-group-mobile mb-2">
                        <input type="text" class="form-control rule-allowed-ip" value="${ip}" placeholder="e.g., 192.168.1.1">
                        <button class="btn btn-outline-danger remove-ip-btn" type="button">
                            <i class="bi bi-trash"></i>
                            <span class="ms-1">Remove</span>
                        </button>
                    </div>
                `).join('');

                ruleEl.innerHTML = `
                    <div class="card-body position-relative">
                        <button type="button" class="btn btn-danger btn-delete" aria-label="Delete"><i class="bi bi-trash-fill"></i></button>
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label fw-bold">Protocols</label>
                                <div class="d-flex flex-wrap gap-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input rule-proto-tcp" type="checkbox" value="tcp" ${protocols.includes('tcp') ? 'checked' : ''}>
                                        <label class="form-check-label">TCP</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input rule-proto-udp" type="checkbox" value="udp" ${protocols.includes('udp') ? 'checked' : ''}>
                                        <label class="form-check-label">UDP</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 col-lg-6 mb-3">
                                <label class="form-label fw-bold">Source (From)</label>
                                <input type="text" class="form-control rule-from" value="${rule.from || ''}" placeholder="e.g., 0.0.0.0:8080">
                            </div>
                            <div class="col-12 col-lg-6 mb-3">
                                <label class="form-label fw-bold">Destination (To)</label>
                                <input type="text" class="form-control rule-to" value="${rule.to || ''}" placeholder="e.g., 127.0.0.1:80">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                Allowed IPs
                                <span class="text-muted fw-normal">(Leave blank to allow all)</span>
                            </label>
                            <div class="allowed-ips-list">
                                ${ipListHTML}
                            </div>
                            <button class="btn btn-outline-primary btn-sm mt-2 add-ip-btn" type="button">
                                <i class="bi bi-plus-circle me-1"></i>
                                Add IP
                            </button>
                        </div>
                    </div>
                `;
                ruleWrapper.appendChild(ruleEl);
                rulesContainer.appendChild(ruleWrapper);
            };

            const loadConfig = async () => {
                try {
                    const response = await fetch('/api/config');
                    if (!response.ok) throw new Error('Failed to load configuration.');
                    currentConfig = await response.json();
                    rulesContainer.innerHTML = '';
                    (currentConfig.forwards || []).forEach(renderRule);
                } catch (error) {
                    showToast(error.message, true);
                }
            };

            const saveConfig = async () => {
                const newForwards = [];
                const ruleElements = document.querySelectorAll('.rule');
                let hasError = false;
                let errorMsg = '';

                ruleElements.forEach(el => {
                    const from = el.querySelector('.rule-from').value;
                    const to = el.querySelector('.rule-to').value;
                    if (!from || !to) {
                        hasError = true;
                        errorMsg = "Fields 'Source (From)' and 'Destination (To)' cannot be empty.";
                    }

                    const protocols = [];
                    if (el.querySelector('.rule-proto-tcp').checked) protocols.push('tcp');
                    if (el.querySelector('.rule-proto-udp').checked) protocols.push('udp');

                    if (protocols.length === 0) {
                        hasError = true;
                        errorMsg = 'Each rule must have at least one protocol (TCP or UDP) selected.';
                    }

                    const allowed_ips = Array.from(el.querySelectorAll('.rule-allowed-ip')).map(input =>
                        input.value.trim()).filter(ip => ip);
                    newForwards.push({
                        protocols,
                        from,
                        to,
                        allowed_ips
                    });
                });

                if (hasError) {
                    showToast(errorMsg, true);
                    return;
                }

                const newConfig = {
                    admin_addr: currentConfig.admin_addr,
                    basic_auth: currentConfig.basic_auth,
                    temp_ip_pool_size: currentConfig.temp_ip_pool_size,
                    forwards: newForwards
                };

                try {
                    saveConfigBtn.disabled = true;
                    saveConfigBtn.innerHTML =
                        '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';

                    const response = await fetch('/api/config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(newConfig)
                    });
                    const responseText = await response.text();
                    if (!response.ok) throw new Error(`Failed to save: ${responseText}`);

                    showToast('Configuration saved and reloaded successfully!');
                    currentConfig = newConfig;
                    // Reload to reflect sorted order from backend if any
                    loadConfig();
                } catch (error) {
                    showToast(error.message, true);
                } finally {
                    saveConfigBtn.disabled = false;
                    saveConfigBtn.innerHTML =
                        '<i class="bi bi-check-circle-fill me-2"></i>Save and Apply';
                }
            };

            addRuleBtn.addEventListener('click', () => renderRule({}, rulesContainer.children.length));

            rulesContainer.addEventListener('click', e => {
                const ruleCard = e.target.closest('.col-12');

                if (e.target.closest('.btn-delete')) {
                    if (confirm('Are you sure you want to delete this rule?')) {
                        ruleCard.remove();
                    }
                } else if (e.target.closest('.add-ip-btn')) {
                    const ipListContainer = e.target.closest('.mb-3').querySelector(
                        '.allowed-ips-list');
                    const newIpInputHTML = `
                        <div class="input-group input-group-mobile mb-2">
                            <input type="text" class="form-control rule-allowed-ip" placeholder="e.g., 192.168.1.1">
                            <button class="btn btn-outline-danger remove-ip-btn" type="button">
                                <i class="bi bi-trash"></i>
                                <span class="ms-1">Remove</span>
                            </button>
                        </div>
                    `;
                    ipListContainer.insertAdjacentHTML('beforeend', newIpInputHTML);
                } else if (e.target.closest('.remove-ip-btn')) {
                    e.target.closest('.input-group').remove();
                }
            });

            saveConfigBtn.addEventListener('click', saveConfig);

            allowMyIpBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to add your IP range (/24) to all rules?')) {
                    return;
                }

                try {
                    allowMyIpBtn.disabled = true;
                    allowMyIpBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';

                    const response = await fetch('/api/allow-my-ip', {
                        method: 'POST',
                    });

                    const responseText = await response.text();
                    if (!response.ok) {
                        throw new Error(`Failed to allow IP range: ${responseText}`);
                    }

                    showToast(responseText);
                    loadConfig(); // Refresh the config to show the new IP
                } catch (error) {
                    showToast(error.message, true);
                } finally {
                    allowMyIpBtn.disabled = false;
                    allowMyIpBtn.innerHTML = '<i class="bi bi-person-check-fill me-2"></i>Allow My IP Range';
                }
            });

            allowCurrentIpBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to add your current IP to the temporary whitelist?')) {
                    return;
                }

                try {
                    allowCurrentIpBtn.disabled = true;
                    allowCurrentIpBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Adding...';

                    const response = await fetch('/api/allow', {
                        method: 'POST',
                    });

                    const responseText = await response.text();
                    if (!response.ok) {
                        throw new Error(`Failed to allow current IP: ${responseText}`);
                    }

                    showToast(responseText);
                    loadIPPool(); // Refresh IP pool
                } catch (error) {
                    showToast(error.message, true);
                } finally {
                    allowCurrentIpBtn.disabled = false;
                    allowCurrentIpBtn.innerHTML = '<i class="bi bi-shield-check me-2"></i>Allow Current IP';
                }
            });

            refreshIpPoolBtn.addEventListener('click', () => {
                loadIPPool();
            });

            viewDuplicateRequestsBtn.addEventListener('click', () => {
                window.location.href = '/duplicates';
            });

            // Logout functionality
            logoutBtn.addEventListener('click', async () => {
                if (!confirm('Are you sure you want to logout?')) {
                    return;
                }

                try {
                    const response = await fetch('/api/logout', {
                        method: 'POST'
                    });

                    if (response.ok) {
                        // Redirect to login page
                        window.location.href = '/login';
                    } else {
                        showToast('Logout failed. Please try again.', true);
                    }
                } catch (error) {
                    showToast('Logout failed. Please try again.', true);
                }
            });

            // Handle temporary IP removal
            document.addEventListener('click', async (e) => {
                if (e.target.closest('.remove-temp-ip-btn')) {
                    const btn = e.target.closest('.remove-temp-ip-btn');
                    const ip = btn.dataset.ip;

                    if (!confirm(`Are you sure you want to remove ${ip} from the temporary whitelist?`)) {
                        return;
                    }

                    try {
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                        const response = await fetch(`/api/remove-temp-ip`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ ip: ip })
                        });

                        const responseText = await response.text();
                        if (!response.ok) {
                            throw new Error(`Failed to remove IP: ${responseText}`);
                        }

                        showToast(responseText);
                        loadIPPool(); // Refresh IP pool display
                    } catch (error) {
                        showToast(error.message, true);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-trash"></i>';
                    }
                }
            });

            loadConfig();
            fetchAndDisplayIP();
            loadIPPool();
            checkDuplicateRequests();
        });
    </script>
</body>

</html>